name: CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test-c:
    name: C Tests (GCC ${{ matrix.gcc-version }}, ${{ matrix.build-type }})
    runs-on: ubuntu-latest
    container: gcc:${{ matrix.gcc-version }}
    strategy:
      fail-fast: false
      matrix:
        gcc-version: [13, 14, 15]
        build-type: [Debug, Release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        apt update
        apt install -y cmake
    
    - name: Verify GCC version
      run: |
        gcc --version
        g++ --version
        gcc -dumpversion
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build-type }}
    
    - name: Build
      run: cmake --build build --config ${{ matrix.build-type }} -j$(nproc)
    
    - name: Run C tests
      run: |
        cd build
        ctest --output-on-failure --verbose -R "^test_(features|vector_ops|thread_safe_detection|resolver_macro)$"
    
    - name: Run benchmarks
      if: matrix.build-type == 'Release'
      run: |
        cd build/bench
        ./benchmark_vector_mul || true
    
    - name: List features
      run: |
        cmake -B build-list -DLIST_FEATURES=ON || true

  build-and-test-cpp:
    name: C++ Tests (GCC ${{ matrix.gcc-version }}, ${{ matrix.build-type }})
    runs-on: ubuntu-latest
    container: gcc:${{ matrix.gcc-version }}
    strategy:
      fail-fast: false
      matrix:
        gcc-version: [13, 14, 15]
        build-type: [Debug, Release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        apt update
        apt install -y cmake
    
    - name: Verify GCC/G++ version
      run: |
        gcc --version
        g++ --version
        gcc -dumpversion
    
    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build-type }}
    
    - name: Build
      run: cmake --build build --config ${{ matrix.build-type }} -j$(nproc)
    
    - name: Run C++ tests
      run: |
        cd build
        ctest --output-on-failure --verbose -R "^test_cpp_"

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y gcc-13 g++-13 clang-format cppcheck
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
    
    - name: Check formatting
      run: |
        find src include features tests bench -name '*.c' -o -name '*.h' | \
        xargs clang-format --dry-run --Werror 2>/dev/null || \
        echo "Note: clang-format check skipped or has minor issues"
    
    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,style,performance,portability \
          --error-exitcode=0 \
          --inline-suppr \
          -I include \
          src/ features/ tests/ 2>&1 | tee cppcheck-report.txt
    
    - name: Upload cppcheck results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cppcheck-report
        path: cppcheck-report.txt

  simd-verification:
    name: SIMD Instruction Verification
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install GCC 13
      run: |
        sudo apt update
        sudo apt install -y gcc-13 g++-13 binutils
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
    
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.25.x'
    
    - name: Build Release
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc-13 -DCMAKE_CXX_COMPILER=g++-13
        cmake --build build -j$(nproc)
    
    - name: Check for SIMD instructions
      run: |
        chmod +x scripts/check_for_simd.sh
        ./scripts/check_for_simd.sh || true
    
    - name: Verify object files contain SIMD
      run: |
        echo "=== Checking for SIMD instructions in object files ==="
        find build -name "*.o" -exec sh -c \
          'objdump -d {} | grep -E "(vpx|vf|vmov|vadd|vmul|vsub)" && echo "Found SIMD in: {}"' \; \
          || echo "Note: Some object files may not contain SIMD instructions (expected for scalar fallbacks)"

  build-docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate documentation
      run: |
        echo "Checking documentation files..."
        test -f README.md
        test -f docs/ARCHITECTURE.md
        echo "All documentation files present"
    
    - name: Check for broken links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        config-file: '.github/workflows/markdown-link-check.json'
      continue-on-error: true

  build-artifacts:
    name: Build & Archive Artifacts
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install GCC 13
      run: |
        sudo apt update
        sudo apt install -y gcc-13 g++-13
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
    
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.25.x'
    
    - name: Build Release
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc-13 -DCMAKE_CXX_COMPILER=g++-13
        cmake --build build -j$(nproc)
    
    - name: Package libraries
      run: |
        mkdir -p artifacts/lib artifacts/include
        cp -r build/src/*.a build/features/*/*.a artifacts/lib/ || true
        cp -r include/* artifacts/include/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libdynemit-libraries
        path: artifacts/
        retention-days: 10
